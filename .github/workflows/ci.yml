name: ci

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  validate:
    permissions:
      contents: read
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - ubuntu-22.04
          - macos-latest
          - macos-14
          - windows-latest
          - windows-2022
        node-version: ['22.x', '24.x']
    timeout-minutes: 15
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        timeout-minutes: 2
        uses: actions/checkout@v4

      - name: Setup Node
        id: setup-node
        timeout-minutes: 2
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix['node-version'] }}
          cache: "npm"

      - name: Install
        timeout-minutes: 5
        run: npm ci --ignore-scripts --prefer-offline --verbose --no-fund

      - name: Lint
        timeout-minutes: 3
        run: npm run lint --if-present

      - name: Test
        timeout-minutes: 5
        run: npm test --if-present

      - name: Upload test reports
        timeout-minutes: 2
        uses: actions/upload-artifact@v6
        with:
          name: test-reports-${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}
          path: "**/test-reports/**"

  docs:
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        timeout-minutes: 2
        uses: actions/checkout@v4

      - name: Setup Node
        id: setup-node
        timeout-minutes: 2
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        timeout-minutes: 5
        run: npm ci --ignore-scripts --prefer-offline --verbose --no-fund

      - name: Docs
        timeout-minutes: 3
        run: npm run docs --if-present

      - name: Upload docs
        timeout-minutes: 2
        uses: actions/upload-artifact@v6
        with:
          name: docs
          path: "**/docs/**"

  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      checks: write
      contents: read
    steps:
      - name: Checkout
        timeout-minutes: 2
        uses: actions/checkout@v4

      - name: Setup Node
        timeout-minutes: 2
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        timeout-minutes: 5
        run: npm ci --ignore-scripts --prefer-offline --verbose --no-fund

      - name: Audit (prod deps only)
        timeout-minutes: 3
        run: |
          npm audit --omit=dev --json > audit.json || true

      - name: Annotate audit findings
        timeout-minutes: 3
        uses: actions/github-script@v7
        with:
          script: |
            const { default: run } = await import('${{ github.workspace }}/.github/scripts/npm-audit-annotator.js')
            await run({ github, context })
